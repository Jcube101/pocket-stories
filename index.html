<!-- index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Stories</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/litegraph.js@0.7.18/css/litegraph.css">
    <script src="https://cdn.jsdelivr.net/npm/litegraph.js@0.7.18/build/litegraph.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/js-yaml/4.1.0/js-yaml.min.js"></script>
</head>
<body>
    <div id="app">
        <header>
            <h1>Pocket Stories</h1>
            <div id="mode-buttons">
                <button id="editor-btn" class="active">Editor Mode</button>
                <button id="player-btn">Player Mode</button>
            </div>
        </header>

        <div id="editor-mode" class="mode">
            <div id="sidebar">
                <h2>Global Variables</h2>
                <div id="variables"></div>
                <button id="add-var">Add Variable</button>

                <h2>Tools</h2>
                <button id="branching-script">View as Branching Script</button>
                <button id="export-yaml">Export story.yaml</button>
                <button id="play-story">Play Story</button>

                <h2>Import Story</h2>
                <label class="file-upload-label">
                    Load story.yaml
                    <input type="file" id="load-story" accept=".yaml,.yml">
                </label>

                <h2>Canvas Controls</h2>
                <button id="zoom-in">+</button>
                <button id="zoom-out">−</button>
                <button id="zoom-fit">Fit All</button>
                <button id="zoom-reset">100%</button>
            </div>
            <div id="graph-container">
                <canvas id="graphcanvas"></canvas>
            </div>
        </div>

        <div id="player-mode" class="mode hidden">
            <div id="top-bar">
                <button id="restart">Restart</button>
                <button id="save-progress">Download Progress</button>
                <label>
                    Upload Progress
                    <input type="file" id="load-progress" accept=".txt">
                </label>
                <button id="export-novel">Export as Novel</button>
                <button id="back-editor">Back to Editor</button>
            </div>
            <div id="passage-container">
                <div id="passage-text"></div>
                <div id="choices"></div>
            </div>
        </div>
    </div>

    <div id="modal" class="modal hidden">
        <div class="modal-content">
            <span class="close">&times;</span>
            <pre id="modal-body"></pre>
        </div>
    </div>

    <script src="editor.js"></script>
    <script src="player.js"></script>
    <script>
        // Main app logic for mode switching
        const editorMode = document.getElementById('editor-mode');
        const playerMode = document.getElementById('player-mode');
        const editorBtn = document.getElementById('editor-btn');
        const playerBtn = document.getElementById('player-btn');

        editorBtn.addEventListener('click', () => {
            editorMode.classList.remove('hidden');
            playerMode.classList.add('hidden');
            editorBtn.classList.add('active');
            playerBtn.classList.remove('active');
        });

        playerBtn.addEventListener('click', () => {
            editorMode.classList.add('hidden');
            playerMode.classList.remove('hidden');
            editorBtn.classList.remove('active');
            playerBtn.classList.add('active');
            startPlayer(); // from player.js
        });

        document.getElementById('back-editor').addEventListener('click', () => {
            editorBtn.click();
        });

        // Load initial story
        fetch('story.yaml')
            .then(r => r.text())
            .then(text => {
                window.storyData = jsyaml.load(text);  // ← correct global name
                initEditor();
                initPlayer();
            })
            .catch(err => {
                console.error("Failed to load initial story.yaml", err);
                alert("Could not load story.yaml — check console and network tab.");
            });
    </script>
</body>
</html>